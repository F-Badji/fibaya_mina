-- Migration pour ajouter la validation des numéros de téléphone par pays
-- Exécuter ce script dans PostgreSQL

-- Se connecter à la base de données Fibaya
\c "Fibaya";

-- 1. Créer la table des formats de numéros mobiles par pays
CREATE TABLE IF NOT EXISTS phone_formats (
    id BIGSERIAL PRIMARY KEY,
    country_name VARCHAR(100) NOT NULL UNIQUE,
    country_code VARCHAR(10) NOT NULL,
    total_digits INTEGER NOT NULL,
    mobile_prefixes TEXT[] NOT NULL,
    example_number VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. Insérer les formats de numéros pour tous les pays
INSERT INTO phone_formats (country_name, country_code, total_digits, mobile_prefixes, example_number) VALUES
-- Afrique
('Sénégal', '+221', 9, ARRAY['70', '75', '76', '77', '78'], '781234567'),
('Mali', '+223', 8, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '60123456'),
('Burkina Faso', '+226', 8, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79'], '60123456'),
('Côte d''Ivoire', '+225', 10, ARRAY['07', '05', '01'], '0712345678'),
('Guinée', '+224', 9, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69'], '601234567'),
('Gambie', '+220', 7, ARRAY['30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '3012345'),
('Guinée-Bissau', '+245', 7, ARRAY['50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '5012345'),
('Cap-Vert', '+238', 7, ARRAY['90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '9012345'),
('Mauritanie', '+222', 8, ARRAY['20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '20123456'),
('Niger', '+227', 8, ARRAY['80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '80123456'),
('Tchad', '+235', 8, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '60123456'),
('Cameroun', '+237', 9, ARRAY['65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '651234567'),
('Gabon', '+241', 8, ARRAY['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '01123456'),
('Congo', '+242', 9, ARRAY['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '011234567'),
('République démocratique du Congo', '+243', 9, ARRAY['80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '801234567'),
('Centrafrique', '+236', 8, ARRAY['70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '70123456'),
('Togo', '+228', 8, ARRAY['90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '90123456'),
('Bénin', '+229', 8, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '60123456'),
('Nigeria', '+234', 10, ARRAY['70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '7012345678'),
('Ghana', '+233', 9, ARRAY['20', '24', '26', '27', '28', '50', '54', '55', '56', '57', '59'], '201234567'),
('Liberia', '+231', 8, ARRAY['70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '70123456'),
('Sierra Leone', '+232', 8, ARRAY['20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '20123456'),
('Maroc', '+212', 9, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '601234567'),
('Algérie', '+213', 9, ARRAY['5', '6', '7', '9'], '501234567'),
('Tunisie', '+216', 8, ARRAY['20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '20123456'),
('Égypte', '+20', 10, ARRAY['10', '11', '12', '15'], '1012345678'),
('Afrique du Sud', '+27', 9, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '601234567'),
('Kenya', '+254', 9, ARRAY['70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '701234567'),
('Éthiopie', '+251', 9, ARRAY['90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '901234567'),
('Ouganda', '+256', 9, ARRAY['70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '701234567'),
('Tanzanie', '+255', 9, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '601234567'),
('Rwanda', '+250', 9, ARRAY['70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '701234567'),
('Burundi', '+257', 8, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '60123456'),
('Madagascar', '+261', 9, ARRAY['30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '301234567'),
('Maurice', '+230', 8, ARRAY['50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '50123456'),
('Seychelles', '+248', 7, ARRAY['20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '2012345'),
('Comores', '+269', 7, ARRAY['30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '3012345'),
('Djibouti', '+253', 8, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '60123456'),
('Somalie', '+252', 8, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '60123456'),
('Soudan', '+249', 9, ARRAY['90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '901234567'),
('Soudan du Sud', '+211', 9, ARRAY['90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '901234567'),
('Érythrée', '+291', 7, ARRAY['10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '1012345'),
('Zimbabwe', '+263', 9, ARRAY['70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '701234567'),
('Zambie', '+260', 9, ARRAY['70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '701234567'),
('Botswana', '+267', 8, ARRAY['70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '70123456'),
('Namibie', '+264', 9, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '601234567'),
('Angola', '+244', 9, ARRAY['9'], '901234567'),
('Mozambique', '+258', 9, ARRAY['80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '801234567'),
('Malawi', '+265', 9, ARRAY['80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '801234567'),
('Lesotho', '+266', 8, ARRAY['50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '50123456'),
('Eswatini', '+268', 8, ARRAY['60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '60123456'),
('São Tomé-et-Príncipe', '+239', 7, ARRAY['90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '9012345'),
('Guinée équatoriale', '+240', 9, ARRAY['20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72', '73', '74', '75', '76', '77', '78', '79', '80', '81', '82', '83', '84', '85', '86', '87', '88', '89', '90', '91', '92', '93', '94', '95', '96', '97', '98', '99'], '201234567'),

-- Europe
('France', '+33', 10, ARRAY['06', '07'], '0612345678'),
('Allemagne', '+49', 11, ARRAY['15', '16', '17'], '15123456789'),
('Royaume-Uni', '+44', 10, ARRAY['7'], '7012345678'),
('Italie', '+39', 10, ARRAY['3'], '3012345678'),
('Espagne', '+34', 9, ARRAY['6', '7'], '601234567'),
('Belgique', '+32', 9, ARRAY['4'], '401234567'),
('Suisse', '+41', 9, ARRAY['7'], '701234567'),
('Pays-Bas', '+31', 9, ARRAY['6'], '601234567'),
('Suède', '+46', 9, ARRAY['7'], '701234567'),
('Norvège', '+47', 8, ARRAY['4', '9'], '40123456'),
('Danemark', '+45', 8, ARRAY['2', '3', '4', '5', '6', '7', '8', '9'], '20123456'),
('Finlande', '+358', 9, ARRAY['4', '5'], '401234567'),
('Pologne', '+48', 9, ARRAY['5', '6', '7', '8', '9'], '501234567'),
('République tchèque', '+420', 9, ARRAY['6', '7'], '601234567'),
('Hongrie', '+36', 9, ARRAY['2', '3', '4', '5', '6', '7', '8', '9'], '201234567'),
('Roumanie', '+40', 9, ARRAY['7'], '701234567'),
('Bulgarie', '+359', 9, ARRAY['8', '9'], '801234567'),
('Grèce', '+30', 10, ARRAY['6'], '6012345678'),
('Portugal', '+351', 9, ARRAY['9'], '901234567'),
('Turquie', '+90', 10, ARRAY['5'], '5012345678'),
('Russie', '+7', 10, ARRAY['9'], '9012345678'),
('Ukraine', '+380', 9, ARRAY['5', '6', '7', '8', '9'], '501234567'),
('Israël', '+972', 9, ARRAY['5'], '501234567'),
('Albanie', '+355', 9, ARRAY['6'], '601234567'),
('Andorre', '+376', 6, ARRAY['3', '4', '6'], '301234'),
('Autriche', '+43', 10, ARRAY['6'], '6012345678'),

-- Asie
('Chine', '+86', 11, ARRAY['1'], '10123456789'),
('Japon', '+81', 11, ARRAY['7', '8', '9'], '70123456789'),
('Inde', '+91', 10, ARRAY['6', '7', '8', '9'], '6012345678'),
('Corée du Sud', '+82', 10, ARRAY['1'], '1012345678'),
('Thaïlande', '+66', 9, ARRAY['6', '8', '9'], '601234567'),
('Vietnam', '+84', 9, ARRAY['3', '5', '7', '8', '9'], '301234567'),
('Malaisie', '+60', 9, ARRAY['1'], '101234567'),
('Singapour', '+65', 8, ARRAY['8', '9'], '80123456'),
('Indonésie', '+62', 10, ARRAY['8'], '8012345678'),
('Philippines', '+63', 10, ARRAY['9'], '9012345678'),
('Cambodge', '+855', 9, ARRAY['1', '6', '7', '8', '9'], '101234567'),
('Laos', '+856', 8, ARRAY['2', '3', '4', '5', '6', '7', '8', '9'], '20123456'),
('Myanmar', '+95', 9, ARRAY['9'], '901234567'),
('Sri Lanka', '+94', 9, ARRAY['7'], '701234567'),
('Népal', '+977', 10, ARRAY['9'], '9012345678'),
('Bhoutan', '+975', 8, ARRAY['1', '2', '3', '4', '5', '6', '7', '8', '9'], '10123456'),
('Maldives', '+960', 7, ARRAY['7', '9'], '7012345'),
('Mongolie', '+976', 8, ARRAY['8', '9'], '80123456'),
('Kazakhstan', '+7', 10, ARRAY['7'], '7012345678'),
('Ouzbékistan', '+998', 9, ARRAY['9'], '901234567'),
('Kirghizistan', '+996', 9, ARRAY['5', '7', '9'], '501234567'),
('Tadjikistan', '+992', 9, ARRAY['9'], '901234567'),
('Turkménistan', '+993', 8, ARRAY['6', '7', '8', '9'], '60123456'),
('Afghanistan', '+93', 9, ARRAY['7'], '701234567'),
('Pakistan', '+92', 10, ARRAY['3'], '3012345678'),
('Bangladesh', '+880', 10, ARRAY['1'], '1012345678'),

-- Moyen-Orient
('Arabie saoudite', '+966', 9, ARRAY['5'], '501234567'),
('Émirats arabes unis', '+971', 9, ARRAY['5'], '501234567'),
('Qatar', '+974', 8, ARRAY['3', '5', '6', '7'], '30123456'),
('Koweït', '+965', 8, ARRAY['5', '6', '9'], '50123456'),
('Bahreïn', '+973', 8, ARRAY['3', '6', '7'], '30123456'),
('Oman', '+968', 8, ARRAY['7', '9'], '70123456'),
('Jordanie', '+962', 9, ARRAY['7'], '701234567'),
('Liban', '+961', 8, ARRAY['3', '7', '8', '9'], '30123456'),
('Irak', '+964', 10, ARRAY['7'], '7012345678'),
('Iran', '+98', 10, ARRAY['9'], '9012345678'),

-- Amériques
('États-Unis', '+1', 10, ARRAY['2', '3', '4', '5', '6', '7', '8', '9'], '2012345678'),
('Canada', '+1', 10, ARRAY['2', '3', '4', '5', '6', '7', '8', '9'], '2012345678'),
('Brésil', '+55', 11, ARRAY['9'], '90123456789'),
('Argentine', '+54', 10, ARRAY['9'], '9012345678'),
('Australie', '+61', 9, ARRAY['1', '4'], '401234567');

-- 3. Créer un index pour les performances
CREATE INDEX IF NOT EXISTS idx_phone_formats_country_name ON phone_formats(country_name);
CREATE INDEX IF NOT EXISTS idx_phone_formats_country_code ON phone_formats(country_code);

-- 4. Créer une fonction de validation des numéros de téléphone
CREATE OR REPLACE FUNCTION validate_phone_number(
    phone_number TEXT,
    country_name TEXT
) RETURNS BOOLEAN AS $$
DECLARE
    format_record RECORD;
    clean_number TEXT;
    prefix TEXT;
    is_valid BOOLEAN := FALSE;
BEGIN
    -- Nettoyer le numéro (enlever espaces, tirets, etc.)
    clean_number := regexp_replace(phone_number, '[^0-9]', '', 'g');
    
    -- Vérifier si le numéro est vide après nettoyage
    IF clean_number = '' THEN
        RETURN FALSE;
    END IF;
    
    -- Récupérer le format du pays
    SELECT * INTO format_record 
    FROM phone_formats 
    WHERE phone_formats.country_name = validate_phone_number.country_name;
    
    -- Vérifier si le pays existe
    IF NOT FOUND THEN
        RETURN FALSE;
    END IF;
    
    -- Vérifier la longueur
    IF length(clean_number) != format_record.total_digits THEN
        RETURN FALSE;
    END IF;
    
    -- Vérifier le préfixe mobile
    FOREACH prefix IN ARRAY format_record.mobile_prefixes
    LOOP
        IF clean_number LIKE prefix || '%' THEN
            is_valid := TRUE;
            EXIT;
        END IF;
    END LOOP;
    
    RETURN is_valid;
END;
$$ LANGUAGE plpgsql;

-- 5. Créer une fonction pour obtenir le format d'un pays
CREATE OR REPLACE FUNCTION get_phone_format(country_name TEXT)
RETURNS TABLE(
    country_code TEXT,
    total_digits INTEGER,
    mobile_prefixes TEXT[],
    example_number TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        pf.country_code,
        pf.total_digits,
        pf.mobile_prefixes,
        pf.example_number
    FROM phone_formats pf
    WHERE pf.country_name = get_phone_format.country_name;
END;
$$ LANGUAGE plpgsql;

-- 6. Ajouter une contrainte de validation sur la table users
ALTER TABLE users ADD CONSTRAINT check_phone_format 
CHECK (validate_phone_number(phone, (
    SELECT cc.name 
    FROM country_codes cc 
    WHERE cc.code = users.country_code
)));

-- 7. Créer un trigger pour mettre à jour updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_phone_formats_updated_at 
    BEFORE UPDATE ON phone_formats 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();

-- 8. Insérer les données dans country_codes si elles n'existent pas
INSERT INTO country_codes (name, code, flag) 
SELECT country_name, country_code, '🏳️' 
FROM phone_formats 
WHERE NOT EXISTS (
    SELECT 1 FROM country_codes cc 
    WHERE cc.name = phone_formats.country_name
);

-- 9. Afficher un message de confirmation
DO $$
BEGIN
    RAISE NOTICE 'Migration terminée avec succès!';
    RAISE NOTICE 'Table phone_formats créée avec % pays', (SELECT COUNT(*) FROM phone_formats);
    RAISE NOTICE 'Fonction validate_phone_number créée';
    RAISE NOTICE 'Contrainte de validation ajoutée à la table users';
END $$;
